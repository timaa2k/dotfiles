# If not running interactively, don't do anything
case $- in
    *i*) ;;
      *) return;;
esac


# No locking on Ctrl-S
stty -ixon

# Check the window size after each command and, if necessary,
# update the values of LINES and COLUMNS.
shopt -s checkwinsize

# History: http://mywiki.wooledge.org/BashFAQ/088

# don't put duplicate lines or lines starting with space in the history.
# See bash(1) for more options
HISTCONTROL=ignoreboth

# Big history
HISTFILESIZE=50000
HISTSIZE=50000

# histappend which causes all new history lines to be appended, and ensures
# that multiple logins do not overwrite each other's history
shopt -s histappend


# Set variables

export PATH=${HOME}/bin:${HOME}/.local/bin:/run/current-system/sw/bin:${PATH}
export PATH=$PATH:${HOME}/bin/go/bin

export SHELL=$(which bash)
export EDITOR=$(which hx)

export FZF_DEFAULT_COMMAND='fd --type f --strip-cwd-prefix --hidden --follow --exclude .git'
export FZF_DEFAULT_OPTS="--height 80% --color=light"

export BAT_STYLE=changes,header,numbers,snip
export BAT_THEME=base16

export AICHAT_CONFIG_DIR="${HOME}/.config/aichat"
export AICHAT_ENV_FILE="${HOME}/.env"


# Source configuration:

if [ -f ~/.bash_aliases ]; then
    . ~/.bash_aliases
fi

if [ -f /etc/bash_completion ] && ! shopt -oq posix; then
    . /etc/bash_completion
fi

if command -v fzf >/dev/null; then
  eval "$(fzf --bash)"
fi


# Set up custom prompt

parse_git_branch() {
  git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/ (\1)/'
}

PROMPT_COMMAND=__prompt_command

__prompt_command() {
    local Exit="$?"
    PS1=""

    local RCol='\[\e[0m\]'

    local UBlu='\[\e[0;4;34m\]'
    local Gre='\[\e[0;32m\]'
    local Red='\[\e[0;31m\]'
    local Blu='\[\e[0;34m\]'

    PS1+="\u@\h ${UBlu}\w${RCol}${Gre}$(parse_git_branch)${RCol}\n"

    if [ $Exit != 0 ]; then
        PS1+="${Red}[${Exit}]${RCol} "
    fi

    if [[ -v IN_NIX_SHELL ]]; then
        PS1+="${Blu}nix-shell>${RCol} "
    else
        PS1+="\$ "
    fi

    history -a
}
